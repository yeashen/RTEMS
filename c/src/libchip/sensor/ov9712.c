/******************************************************************************

	Copyright (C), 2015-2025, SHARPNOW Co., Ltd.

 ******************************************************************************
  File Name     : ov9712.c
  Version       : Initial Draft
  Author        : Juven
  Created       : 2016/04/06
  Last Modified : 
  Description   : sensor ov9712 driver 
  History       : 
  1.Date        : 2016/04/06
   Author       : Juven
   Modification : Created file

******************************************************************************/
#include <rtems.h>
#include <rtems/libi2c.h>

#include <libchip/ov9712.h>
#include <i2c.h>

#include <rtems/libio.h>

#define ARRAY_SIZE(array) (sizeof(array) / sizeof(array[0]))

static SENSOR_DATA_S ov9712_init_para_1280_720[] = {
	{0x12, 0x80}, {0x09, 0x10}, {0x1e, 0x07}, {0x5f, 0x18}, {0x69, 0x04}, {0x65, 0x2a}, {0x68, 0x0a}, {0x39, 0x28},
	{0x4d, 0x90}, {0xc1, 0x80}, {0x0c, 0x30}, {0x6d, 0x02}, {0x96, 0x01}, {0xbc, 0x68}, {0x12, 0x00}, {0x3b, 0x00},
	{0x97, 0x80}, {0x17, 0x25}, {0x18, 0xA2}, {0x19, 0x01}, {0x1a, 0xCA}, {0x03, 0x0A}, {0x32, 0x07}, {0x98, 0x00},
	{0x99, 0x28}, {0x9a, 0x00}, {0x57, 0x00}, {0x58, 0xB4}, {0x59, 0xA0}, {0x4c, 0x13}, {0x4b, 0x36}, {0x3d, 0x3c},
	{0x3e, 0x03}, {0xbd, 0xA0}, {0xbe, 0xb4}, {0x4e, 0x55}, {0x4f, 0x55}, {0x50, 0x55}, {0x51, 0x55}, {0x24, 0x55},
	{0x25, 0x40}, {0x26, 0xa1}, {0x5c, 0x52}, {0x5d, 0x00}, {0x11, 0x01}, {0x2a, 0x4C}, {0x2b, 0x03}, {0x2d, 0x00},
	{0x2e, 0x00}, {0x13, 0xA5}, {0x14, 0x40}, {0x4a, 0x00}, {0x49, 0xce}, {0x22, 0x03}, {0x09, 0x00}, {0x13, 0x80},
	{0x16, 0x00}, {0x10, 0xf0}, {0x00, 0x3f}, {0x38, 0x00}, {0x01, 0x40}, {0x02, 0x40}, {0x05, 0x40}, {0x06, 0x00},
	{0x07, 0x00},{0x41, 0x50},
};

static SENSOR_DATA_S ov9712_init_para_640_400[] = {
	{0x12, 0x80}, {0x09, 0x10}, {0x1e, 0x07}, {0x5f, 0x18}, {0x69, 0x04}, {0x65, 0x2a}, {0x68, 0x0a}, {0x39, 0x28},
	{0x4d, 0x90}, {0xc1, 0x80}, {0x0c, 0x30}, {0x6d, 0x02}, {0x96, 0x01}, {0xbc, 0x68}, {0x12, 0x00}, {0x3b, 0x00},
	{0x97, 0x80}, {0x17, 0x25}, {0x18, 0x51}, {0x19, 0x01}, {0x1a, 0x65}, {0x03, 0x06}, {0x32, 0x07}, {0x98, 0x00},
	{0x99, 0x28}, {0x9a, 0x00}, {0x57, 0x00}, {0x58, 0x64}, {0x59, 0x50}, {0x4c, 0x13}, {0x4b, 0x36}, {0x3d, 0x3c},
	{0x3e, 0x03}, {0xbd, 0x50}, {0xbe, 0x64}, {0x4e, 0x55}, {0x4f, 0x55}, {0x50, 0x55}, {0x51, 0x55}, {0x24, 0x55},
	{0x25, 0x40}, {0x26, 0xa1}, {0x5c, 0x52}, {0x5d, 0x00}, {0x11, 0x01}, {0x2a, 0x4C}, {0x2b, 0x03}, {0x2d, 0x00},
	{0x2e, 0x00}, {0x13, 0xA5}, {0x14, 0x40}, {0x4a, 0x00}, {0x49, 0xce}, {0x22, 0x03}, {0x09, 0x00}, {0x13, 0x80},
	{0x16, 0x00}, {0x10, 0xf0}, {0x00, 0x3f}, {0x38, 0x00}, {0x01, 0x40}, {0x02, 0x40}, {0x05, 0x40}, {0x06, 0x00},
	{0x07, 0x00},{0x41, 0x50},
};

/* debug */
static SENSOR_DATA_S ov9712_init_para_640_400_colorbar[] = {
	{0x12, 0x80}, {0x09, 0x10}, {0x1e, 0x07}, {0x5f, 0x18}, {0x69, 0x04}, {0x65, 0x2a}, {0x68, 0x0a}, {0x39, 0x28},
	{0x4d, 0x90}, {0xc1, 0x80}, {0x0c, 0x30}, {0x6d, 0x02}, {0x96, 0x01}, {0xbc, 0x68}, {0x12, 0x00}, {0x3b, 0x00},
	{0x97, 0x88}, {0x17, 0x25}, {0x18, 0x51}, {0x19, 0x01}, {0x1a, 0x65}, {0x03, 0x06}, {0x32, 0x07}, {0x98, 0x00},
	{0x99, 0x28}, {0x9a, 0x00}, {0x57, 0x00}, {0x58, 0x64}, {0x59, 0x50}, {0x4c, 0x13}, {0x4b, 0x36}, {0x3d, 0x3c},
	{0x3e, 0x03}, {0xbd, 0x50}, {0xbe, 0x64}, {0x4e, 0x55}, {0x4f, 0x55}, {0x50, 0x55}, {0x51, 0x55}, {0x24, 0x55},
	{0x25, 0x40}, {0x26, 0xa1}, {0x5c, 0x52}, {0x5d, 0x00}, {0x11, 0x01}, {0x2a, 0x4C}, {0x2b, 0x03}, {0x2d, 0x00},
	{0x2e, 0x00}, {0x13, 0xA5}, {0x14, 0x40}, {0x4a, 0x00}, {0x49, 0xce}, {0x22, 0x03}, {0x09, 0x00}, {0x13, 0x80},
	{0x16, 0x00}, {0x10, 0xf0}, {0x00, 0x3f}, {0x38, 0x00}, {0x01, 0x40}, {0x02, 0x40}, {0x05, 0x40}, {0x06, 0x00},
	{0x07, 0x00},{0x41, 0x50},
};

static int i2c_minor = 0;

/* download ov9712 settings to sensor through i2c */
static int ov9712_download_firmware(SENSOR_DATA_S *pModeSetting, int ArySize)
{
	int i, ret;
	uint32_t reg_addr, val;
	i2c_para_s i2c_para;

	i2c_para.dev_addr = SENSOR_I2C_ADDR;
	i2c_para.reg_byte = 1;
	i2c_para.data_byte = 1;

	for(i = 0; i < ArySize; ++i, ++pModeSetting){
		i2c_para.reg_addr = pModeSetting->reg_addr;
		i2c_para.data = pModeSetting->data;
		ret = hi_i2c_write(i2c_minor, &i2c_para);
		if(ret < 0){
			printk("i2c write addr=0x%x val=0x%x error!\n", reg_addr, val);
			return ret;
		}
		//usleep(100);
	}

	return ret;
}

int sensor_ov9712_init(SENSOR_RES_E mode)
{
	SENSOR_DATA_S *pModeSetting = NULL;
	int ArySize = 0, ret = 0;

	hi_i2c_init(i2c_minor);

	switch(mode){
		case MODE_640x400:
			pModeSetting = ov9712_init_para_640_400;
			ArySize = ARRAY_SIZE(ov9712_init_para_640_400);
			break;
		case MODE_640x400_COLORBAR:
			pModeSetting = ov9712_init_para_640_400_colorbar;
			ArySize = ARRAY_SIZE(ov9712_init_para_640_400_colorbar);
			break;
		case MODE_1280x720:
			pModeSetting = ov9712_init_para_1280_720;
			ArySize = ARRAY_SIZE(ov9712_init_para_1280_720);
			break;
		default:
			break;
	}
	ret = ov9712_download_firmware(pModeSetting, ArySize);
	if (ret < 0){
		printk("ov9712_download_firmware failed! try again\n");
		return -1;
	}

	return 0;
}

int sensor_ov9712_read(SENSOR_DATA_S *sensor_data)
{
	i2c_para_s i2c_para;

	i2c_para.dev_addr = SENSOR_I2C_ADDR;
	i2c_para.reg_addr = sensor_data->reg_addr;
	i2c_para.reg_byte = 1;
	i2c_para.data_byte = 1;
	hi_i2c_read(i2c_minor, &i2c_para);

	return i2c_para.data;
}

int sensor_ov9712_write(SENSOR_DATA_S *sensor_data)
{
	i2c_para_s i2c_para;

	i2c_para.dev_addr = SENSOR_I2C_ADDR;
	i2c_para.reg_addr = sensor_data->reg_addr;
	i2c_para.reg_byte = 1;
	i2c_para.data = sensor_data->data;
	i2c_para.data_byte = 1;

	return hi_i2c_write(i2c_minor, &i2c_para);
} 

